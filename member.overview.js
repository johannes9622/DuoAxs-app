import { Router } from 'express'; import { prisma } from '../../index.js'; import { authRequired } from '../middleware/authRequired.js'; const r=Router(); r.get('/overview',authRequired,async(req,res)=>{ const userId=req.user?.sub; const user=await prisma.user.findUnique({where:{id:userId},select:{id:true,email:true,name:true}}).catch(()=>null); const wallet=await prisma.creditWallet.findUnique({where:{userId}}).catch(()=>null); const since=new Date(Date.now()-30*864e5); const recentCheckins=await prisma.checkin.count({where:{userId,createdAt:{gte:since}}}).catch(()=>0); res.json({user:user||{id:userId,email:req.user?.email||'',name:''},credits:{planCredits:wallet?.planCredits||0,topUpCredits:wallet?.topUpCredits||0,total:(wallet?.planCredits||0)+(wallet?.topUpCredits||0),nextResetAt:wallet?.nextResetAt||null},metrics:{recentCheckins}});}); export default r;